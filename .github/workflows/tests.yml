name: Tests

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      NODE_OPTIONS: --experimental-vm-modules
      DATABASE_URL: ${{ secrets.DATABASE_URL != '' && secrets.DATABASE_URL || 'postgres://postgres:postgres@localhost:5432/test' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --coverage

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ github.sha }}
          path: |
            coverage/**
            coverage.*
          if-no-files-found: warn
          retention-days: 30

      - name: Test summary
        if: always()
        uses: actions/github-script@v7
        env:
          JOB_STATUS: ${{ job.status }}
        with:
          script: |
            const fs = require('fs');
            let summary = '## Test Results\n';
            if (process.env.JOB_STATUS === 'success') {
              summary += '✅ Tests passed.\n';
            } else {
              summary += '❌ Tests failed. See logs for details.\n';
            }
            const path = 'coverage/coverage-summary.json';
            if (fs.existsSync(path)) {
              try {
                const data = JSON.parse(fs.readFileSync(path, 'utf8'));
                const total = data.total || {};
                const pct = (k) => total[k] ? total[k].pct : null;
                summary += '\n### Coverage\n';
                summary += `- Statements: ${pct('statements') ?? 'n/a'}%\n`;
                summary += `- Branches: ${pct('branches') ?? 'n/a'}%\n`;
                summary += `- Functions: ${pct('functions') ?? 'n/a'}%\n`;
                summary += `- Lines: ${pct('lines') ?? 'n/a'}%\n`;
              } catch (e) {
                summary += '\nCould not parse coverage summary.\n';
              }
            } else {
              summary += '\nNo coverage summary found (expected coverage/coverage-summary.json).\n';
            }
            await core.summary.addRaw(summary).write();

      - name: Failure annotations
        if: failure()
        run: |
          echo "::error::Unit tests failed. Inspect the logs above. Re-run locally with 'npm test' to reproduce." 
          echo "::notice::If using Jest with ESM, ensure NODE_OPTIONS='--experimental-vm-modules'."
